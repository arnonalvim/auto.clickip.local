{% extends "base.html" %}

{% block content %}
<!-- NOVO: Adicionar CDN do Choices.js no cabeçalho ou antes de fechar o <body> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<h1>Executar comandos em massa</h1>
<p class="text-muted">Selecione uma ou mais OLTs e digite os comandos que deseja executar em todas elas.</p>

<hr>

<form method="POST" action="{{url_for('set_commands_massive_bp.set_commands_massive')}}" autocomplete="off">
    {{ form.hidden_tag() }}

    <div class="mb-4">
        <label class="form-label fw-semibold">
            <i class="fas fa-server me-2 text-primary"></i>Selecionar OLTs
        </label>
        <p class="text-muted small">Comece a digitar para pesquisar e selecionar as OLTs desejadas.</p>
        
        <!-- NOVO: Campo de select será Choices.js -->
        <select id="olt-select" name="hostnames" multiple>
            {% for value, label in form.hostnames.choices %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        
        <div class="mt-2">
            <!-- contagem de selecionados-->
            <span class="text-muted" id="selectedCount">0 OLTs selecionadas</span>
        </div>
    </div>

    <div class="mb-4">
        <label class="form-label fw-semibold">
            <i class="fas fa-terminal me-2 text-primary"></i>{{ form.commands.label }}
        </label>
        <p class="text-muted small">Digite os comandos que deseja executar (um por linha):</p>
        {{ form.commands(class="form-control font-monospace", rows="10") }}
    </div>

    {{ form.submit(class="btn btn-primary btn-lg", onclick="return confirmSubmit()") }}
</form>

<!-- seção de resultados -->
{% if results %}
<hr class="my-4">

<div class="mb-3">
    <h3>Resultados da Execução</h3>
    <div class="row">
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body text-center">
                    <h5 class="card-title">Total</h5>
                    <h2>{{ total_olts }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body text-center">
                    <h5 class="card-title">Sucesso</h5>
                    <h2>{{ successful_olts }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-danger">
                <div class="card-body text-center">
                    <h5 class="card-title">Falhas</h5>
                    <h2>{{ failed_olts }}</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="accordion" id="resultsAccordion">
    {% for result in results %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ loop.index }}">
            <button class="accordion-button collapsed d-flex align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                {% if result.success %}
                    <i class="fas fa-check-circle text-success me-2"></i>
                {% else %}
                    <i class="fas fa-times-circle text-danger me-2"></i>
                {% endif %}
                <strong>{{ result.hostname }}</strong>
                <span class="text-muted ms-2">({{ result.ip }})</span>
                {% if not result.success %}
                    <span class="badge bg-danger ms-auto me-2">ERRO</span>
                {% endif %}
            </button>
        </h2>
        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                {% if result.error %}
                    <div class="alert alert-danger">
                        <strong>Erro:</strong> {{ result.error }}
                    </div>
                {% endif %}
                <pre class="border border-3 rounded-3 p-3 bg-dark text-light" style="max-height: 500px; overflow-y: auto;"><code>{{ result.output }}</code></pre>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endif %}

<!-- SCRIPT TOTALMENTE REFEITO PARA USAR O CHOICES.JS -->
<script>
// Variável global para acessar a instância do Choices
let choicesInstance;

function updateSelectedCount() {
    // Choices para pegar os valores selecionados
    const selectedItems = choicesInstance.getValue(true);
    const count = selectedItems.length;
    const countElement = document.getElementById('selectedCount');
    countElement.textContent = `${count} OLT${count !== 1 ? 's' : ''} selecionada${count !== 1 ? 's' : ''}`;
}

function confirmSubmit() {
    // A verificação agora é feita do Choices
    const selectedItems = choicesInstance.getValue(true);
    const commandsField = document.querySelector('textarea[name="commands"]');
    
    if (selectedItems.length === 0) {
        alert('Por favor, selecione pelo menos uma OLT.');
        return false;
    }
    
    if (!commandsField.value.trim()) {
        alert('Por favor, digite pelo menos um comando.');
        return false;
    }
    
    return confirm(`Você está prestes a executar comandos em ${selectedItems.length} OLT(s). Tem certeza?`);
}

document.addEventListener('DOMContentLoaded', function() {
    const selectElement = document.getElementById('olt-select');
    
    // Inicializa o Choices.js no elemento <select>
    choicesInstance = new Choices(selectElement, {
        removeItemButton: true, // Adiciona um 'x' para remover itens selecionados
        searchPlaceholderValue: 'Pesquisar por nome ou IP...', // Texto de ajuda na busca
        placeholder: true,
        placeholderValue: 'Clique para ver a lista ou comece a digitar',
        noResultsText: 'Nenhum resultado encontrado',
        itemSelectText: 'Pressione Enter para selecionar',
    });

    // Adiciona um listener para o evento 'change' do Choices
    // Ele será disparado sempre que um item for adicionado ou removido
    selectElement.addEventListener('change', updateSelectedCount);

    // Atualiza a contagem inicial (caso a página seja recarregada com valores)
    updateSelectedCount();
});
</script>
{% endblock %}