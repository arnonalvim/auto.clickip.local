{% extends "base.html" %}

{% block content %}
<h1>Atualização de ONUs por GPON</h1>

<hr>

<form method="POST" action="{{url_for('att_onus_gpon_bp.att_onus_gpon')}}" autocomplete="on" id="mainForm">
    {{ form.hidden_tag() }}

    <div class="mb-3">
        <label class="form-label fw-semibold">
            <i class="fas fa-server me-2 text-primary"></i>Selecionar OLT
        </label>
        <div class="position-relative" id="searchable-select-wrapper">
            {{ form.hostname(class="form-control searchable-select") }}
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-2">
            <div class="form-floating">
                {{ form.chassis(class="form-control") }}
                {{ form.chassis.label }}
            </div>
        </div>
        <div class="col-2">
            <div class="form-floating">
                {{ form.slot(class="form-control") }}
                {{ form.slot.label }}
            </div>
        </div>
        <div class="col-2">
            <div class="form-floating">
                {{ form.port_id(class="form-control") }}
                {{ form.port_id.label }}
            </div>
        </div>
    </div>

    <!-- Campo de firmware sempre visível -->
    <div class="mb-3">
        <label class="form-label fw-semibold">
            <i class="fas fa-file me-2 text-primary"></i>Arquivo de Firmware
        </label>
        {{ form.firmware_file(class="form-control", placeholder="Digite o nome do arquivo de firmware (necessário apenas para atualização)") }}
        <div class="form-text">show firmware onu | tab</div>
    </div>

    <div class="mb-3">
        {{ form.submit_get_info(class="btn btn-primary") }}
        <div class="form-text">
            <i class="fas fa-clock me-1 text-warning"></i>
            <strong>Atenção:</strong> A consulta pode demorar até 10 minutos dependendo da quantidade de ONUs na porta.
        </div>
    </div>

    {% if show_table and onus_data %}
    <hr>
    
    <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Instruções:</strong> Selecione as ONUs que deseja atualizar marcando as caixas de seleção na tabela abaixo. 
        Certifique-se de que o arquivo de firmware que foi informado no campo acima está na OLT.
    </div>

    <!-- Filtros da tabela -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtragem - Não esqueça de remover espaços ou caracteres inválidos</h6>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Interface</label>
                    <input type="text" class="form-control form-control-sm filter-input" 
                           id="filter-interface" placeholder="Filtrar interface...">
                </div>
                <div class="col-md-1">
                    <label class="form-label fw-semibold">ID</label>
                    <input type="text" class="form-control form-control-sm filter-input" 
                           id="filter-id" placeholder="ID...">
                </div>
                <div class="col-md-1">
                    <label class="form-label fw-semibold">Estado</label>
                    <select class="form-select form-select-sm filter-input" id="filter-estado">
                        <option value="">Todos</option>
                        <option value="Up">Up</option>
                        <option value="Down">Down</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Serial Number</label>
                    <input type="text" class="form-control form-control-sm filter-input" 
                           id="filter-serial" placeholder="Serial...">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Firmware Active</label>
                    <input type="text" class="form-control form-control-sm filter-input" 
                           id="filter-active-fw" placeholder="Firmware atual...">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Firmware Anterior</label>
                    <input type="text" class="form-control form-control-sm filter-input" 
                           id="filter-standby-fw" placeholder="Firmware em espera...">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Equipamento</label>
                    <input type="text" class="form-control form-control-sm filter-input" 
                           id="filter-equipamento" placeholder="Equipamento...">
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFilters">
                        <i class="fas fa-times me-1"></i>Limpar Filtros
                    </button>
                    <span class="ms-3 text-muted" id="resultCount">
                        Mostrando <span id="visibleRows">{{ onus_data|length }}</span> de {{ onus_data|length }} ONUs
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="onusTable">
            <thead class="table-dark">
                <tr>
                    <th>
                        <input type="checkbox" id="selectAll" class="form-check-input">
                        <label for="selectAll" class="form-check-label ms-1">Todos</label>
                    </th>
                    <th>Interface</th>
                    <th>ID</th>
                    <th>Estado</th>
                    <th>Serial Number</th>
                    <th>Firmware Ativo</th>
                    <th>Firmware Standby</th>
                    <th>Equipamento</th>
                </tr>
            </thead>
            <tbody>
                {% for onu in onus_data %}
                <tr class="onu-row" 
                    data-interface="{{ onu.interface }}"
                    data-id="{{ onu.onu_id }}"
                    data-estado="{{ onu.oper_state }}"
                    data-serial="{{ onu.serial_number }}"
                    data-active-fw="{{ onu.active_fw }}"
                    data-standby-fw="{{ onu.standby_fw }}"
                    data-equipamento="{{ onu.eq_id }}">
                    <td>
                        <input type="checkbox" 
                               class="form-check-input onu-checkbox" 
                               data-chassis="{{ onu.chassis }}"
                               data-slot="{{ onu.slot }}"
                               data-port="{{ onu.port }}"
                               data-onu-id="{{ onu.onu_id }}"
                               data-interface="{{ onu.interface }}"
                               data-serial="{{ onu.serial_number }}"
                               data-active-fw="{{ onu.active_fw }}"
                               data-standby-fw="{{ onu.standby_fw }}"
                               data-eq-id="{{ onu.eq_id }}">
                    </td>
                    <td>{{ onu.interface }}</td>
                    <td>{{ onu.onu_id }}</td>
                    <td>
                        <span class="badge {% if onu.oper_state == 'Up' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ onu.oper_state }}
                        </span>
                    </td>
                    <td>{{ onu.serial_number }}</td>
                    <td>{{ onu.active_fw }}</td>
                    <td>{{ onu.standby_fw }}</td>
                    <td>{{ onu.eq_id }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-eye me-2"></i>Preview dos Comandos</h5>
            </div>
            <div class="card-body">
                <pre id="commandsPreview" class="bg-light p-3 rounded">Selecione ONUs para ver os comandos que serão executados...</pre>
            </div>
        </div>
    </div>

    {{ form.selected_onus() }}

    <div class="mt-3">
        <button type="button" class="btn btn-warning" disabled id="updateBtn">
            <span id="updateBtnText">Requisitar Atualização</span>
            <span id="updateSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
        </button>
    </div>

    {% endif %}
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Script para busca de OLT
    const selectElement = document.querySelector('.searchable-select');

    if (selectElement) {
        const container = document.createElement('div');
        container.className = 'searchable-select-container';
        container.style.position = 'relative';

        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'form-control searchable-input';
        searchInput.placeholder = 'Escreva aqui para filtrar OLTs...';
        searchInput.style.marginBottom = '5px';

        const optionsList = document.createElement('div');
        optionsList.className = 'searchable-options';
        optionsList.style.cssText = `
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            background: white;
            position: absolute;
            width: 100%;
            z-index: 1000;
            display: none;
        `;

        const limparBtn = document.createElement('button');
        limparBtn.type = 'button';
        limparBtn.className = 'btn btn-outline-secondary mt-2';
        limparBtn.textContent = 'Limpar seleção';

        function limparSelecao() {
            selectElement.value = '';
            searchInput.value = '';
            optionsList.style.display = 'none';

            const event = new Event('change', { bubbles: true });
            selectElement.dispatchEvent(event);
        }
        limparBtn.addEventListener('click', limparSelecao);

        const allOptions = Array.from(selectElement.options).slice(1);

        function createOptionItem(option) {
            const item = document.createElement('div');
            item.className = 'searchable-option';
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
            `;
            item.textContent = option.text;
            item.dataset.value = option.value;

            item.addEventListener('mouseenter', function () {
                this.style.backgroundColor = '#f8f9fa';
            });

            item.addEventListener('mouseleave', function () {
                this.style.backgroundColor = 'white';
            });

            item.addEventListener('click', function () {
                selectElement.value = this.dataset.value;
                searchInput.value = this.textContent;
                optionsList.style.display = 'none';

                const event = new Event('change', { bubbles: true });
                selectElement.dispatchEvent(event);
            });

            return item;
        }

        function filterOptions(searchTerm) {
            optionsList.innerHTML = '';

            const filteredOptions = allOptions.filter(option =>
                option.text.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredOptions.length === 0) {
                const noResults = document.createElement('div');
                noResults.style.cssText = 'padding: 8px 12px; color: #6c757d; font-style: italic;';
                noResults.textContent = 'Nenhuma OLT encontrada';
                optionsList.appendChild(noResults);
            } else {
                filteredOptions.forEach(option => {
                    optionsList.appendChild(createOptionItem(option));
                });
            }
        }

        searchInput.addEventListener('input', function () {
            const searchTerm = this.value;
            filterOptions(searchTerm);
            optionsList.style.display = searchTerm ? 'block' : 'none';
        });

        searchInput.addEventListener('focus', function () {
            if (this.value) {
                filterOptions(this.value);
                optionsList.style.display = 'block';
            }
        });

        document.addEventListener('click', function (e) {
            if (!container.contains(e.target)) {
                optionsList.style.display = 'none';
            }
        });

        if (selectElement.value) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            searchInput.value = selectedOption.text;
        }

        const wrapper = document.getElementById('searchable-select-wrapper');
        if (wrapper) {
            wrapper.appendChild(container);
            container.appendChild(searchInput);
            container.appendChild(optionsList);
            container.appendChild(limparBtn);
        }

        selectElement.style.display = 'none';

        allOptions.forEach(option => {
            optionsList.appendChild(createOptionItem(option));
        });
    }

    // Script para filtros da tabela
    const filterInputs = document.querySelectorAll('.filter-input');
    const tableRows = document.querySelectorAll('.onu-row');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const visibleRowsSpan = document.getElementById('visibleRows');
    const totalRows = tableRows.length;

    function applyFilters() {
        const filters = {
            interface: document.getElementById('filter-interface').value.toLowerCase(),
            id: document.getElementById('filter-id').value.toLowerCase(),
            estado: document.getElementById('filter-estado').value.toLowerCase(),
            serial: document.getElementById('filter-serial').value.toLowerCase(),
            activeFw: document.getElementById('filter-active-fw').value.toLowerCase(),
            standbyFw: document.getElementById('filter-standby-fw').value.toLowerCase(),
            equipamento: document.getElementById('filter-equipamento').value.toLowerCase()
        };

        let visibleCount = 0;

        tableRows.forEach(row => {
            const rowData = {
                interface: row.dataset.interface.toLowerCase(),
                id: row.dataset.id.toLowerCase(),
                estado: row.dataset.estado.toLowerCase(),
                serial: row.dataset.serial.toLowerCase(),
                activeFw: row.dataset.activeFw.toLowerCase(),
                standbyFw: row.dataset.standbyFw.toLowerCase(),
                equipamento: row.dataset.equipamento.toLowerCase()
            };

            const matchesFilters = 
                rowData.interface.includes(filters.interface) &&
                rowData.id.includes(filters.id) &&
                (filters.estado === '' || rowData.estado === filters.estado) &&
                rowData.serial.includes(filters.serial) &&
                rowData.activeFw.includes(filters.activeFw) &&
                rowData.standbyFw.includes(filters.standbyFw) &&
                rowData.equipamento.includes(filters.equipamento);

            if (matchesFilters) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
                const checkbox = row.querySelector('.onu-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        });

        visibleRowsSpan.textContent = visibleCount;
        updateSelectAllState();
        updatePreview();
    }

    function clearAllFilters() {
        filterInputs.forEach(input => {
            input.value = '';
        });
        
        tableRows.forEach(row => {
            row.style.display = '';
        });

        visibleRowsSpan.textContent = totalRows;
        updateSelectAllState();
        updatePreview();
    }

    filterInputs.forEach(input => {
        input.addEventListener('input', applyFilters);
        input.addEventListener('change', applyFilters);
    });

    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearAllFilters);
    }

    // Script ajax pego da internet
    const selectAllCheckbox = document.getElementById('selectAll');
    const updateBtn = document.getElementById('updateBtn');
    const updateBtnText = document.getElementById('updateBtnText');
    const updateSpinner = document.getElementById('updateSpinner');
    const selectedOnusInput = document.querySelector('input[name="selected_onus"]');
    const firmwareInput = document.querySelector('input[name="firmware_file"]');
    const commandsPreview = document.getElementById('commandsPreview');

    function getVisibleCheckboxes() {
        return document.querySelectorAll('.onu-row:not([style*="display: none"]) .onu-checkbox');
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const visibleCheckboxes = getVisibleCheckboxes();
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updatePreview();
        });

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('onu-checkbox')) {
                updateSelectAllState();
                updatePreview();
            }
        });

        if (firmwareInput) {
            firmwareInput.addEventListener('input', updatePreview);
        }

        function updateSelectAllState() {
            const visibleCheckboxes = getVisibleCheckboxes();
            const checkedVisible = document.querySelectorAll('.onu-row:not([style*="display: none"]) .onu-checkbox:checked');
            
            if (visibleCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = checkedVisible.length === visibleCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedVisible.length > 0 && checkedVisible.length < visibleCheckboxes.length;
            }
        }

        function updatePreview() {
            const selectedCheckboxes = document.querySelectorAll('.onu-checkbox:checked');
            const firmwareFile = firmwareInput ? firmwareInput.value : '';
            
            let commands = [];
            let selectedOnus = [];

            if (selectedCheckboxes.length > 0 && firmwareFile) {
                selectedCheckboxes.forEach(checkbox => {
                    const chassis = checkbox.dataset.chassis;
                    const slot = checkbox.dataset.slot;
                    const port = checkbox.dataset.port;
                    const onuId = checkbox.dataset.onuId;
                    
                    commands.push(`request firmware onu install ${firmwareFile} interface gpon ${chassis}/${slot}/${port} onu ${onuId}`);
                    
                    selectedOnus.push({
                        chassis: chassis,
                        slot: slot,
                        port: port,
                        onu_id: onuId,
                        interface: checkbox.dataset.interface,
                        serial: checkbox.dataset.serial,
                        active_fw: checkbox.dataset.activeFw,
                        standby_fw: checkbox.dataset.standbyFw,
                        eq_id: checkbox.dataset.eqId
                    });
                });
                
                commandsPreview.textContent = commands.join('\n');
                updateBtn.disabled = false;
                selectedOnusInput.value = JSON.stringify(selectedOnus);
            } else {
                if (selectedCheckboxes.length === 0) {
                    commandsPreview.textContent = 'Selecione ONUs para ver os comandos que serão executados...';
                } else {
                    commandsPreview.textContent = 'Informe o arquivo de firmware para ver os comandos...';
                }
                updateBtn.disabled = true;
                selectedOnusInput.value = '';
            }
        }

        function showAlert(message, type) {
            const existingAlert = document.getElementById('flashAlert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Criar o alert como toast no topo da página
            const alertDiv = document.createElement('div');
            alertDiv.id = 'flashAlert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                min-width: 300px;
                max-width: 600px;
            `;
            
            alertDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show shadow" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="this.closest('#flashAlert').remove()"></button>
                </div>
            `;
            
            // Adicionar ao body
            document.body.appendChild(alertDiv);
            
            // Esconder depois de 5 segundos
            setTimeout(() => {
                if (document.getElementById('flashAlert')) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // AJAX para atualização de firmware
        if (updateBtn) {
            updateBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const hostname = selectElement.value;
                const firmwareFile = firmwareInput.value;
                const selectedOnusData = selectedOnusInput.value;
                
                if (!hostname || !firmwareFile || !selectedOnusData) {
                    showAlert('Por favor, preencha todos os campos necessários', 'danger');
                    return;
                }

                // loading
                updateBtn.disabled = true;
                updateBtnText.textContent = 'Enviando comandos...';
                updateSpinner.style.display = 'inline-block';
                
                // Enviar AJAX
                fetch("{{ url_for('att_onus_gpon_bp.att_onus_gpon_update') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    },
                    body: JSON.stringify({
                        hostname: hostname,
                        firmware_file: firmwareFile,
                        selected_onus: JSON.parse(selectedOnusData)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Erro na comunicação com o servidor: ' + error.message, 'danger');
                })
                .finally(() => {
                    // Restaurar botão
                    updateBtn.disabled = false;
                    updateBtnText.textContent = 'Requisitar Atualização';
                    updateSpinner.style.display = 'none';
                });
            });
        }

        updateSelectAllState();
        updatePreview();
    }
});
</script>
{% endblock %}